<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام حساب الأرباح (نسخة مستقلة)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .positive { color: #22c55e; }
        .negative { color: #ef4444; }
        .toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 50; left: 50%;
            transform: translateX(-50%); bottom: 30px; opacity: 0;
            transition: opacity 0.5s, visibility 0.5s;
        }
        .toast.show { visibility: visible; opacity: 1; }
        #loader {
            border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%;
            width: 60px; height: 60px; animation: spin 1s linear infinite;
            position: absolute; top: 50%; left: 50%; margin-left: -30px; margin-top: -30px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loader" class="hidden"></div>
    <div id="toast" class="toast"></div>

    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
            <!-- Login Form -->
            <div id="login-form">
                <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">تسجيل الدخول</h2>
                <div id="login-error" class="text-red-500 text-center mb-4 hidden"></div>
                <input type="email" id="login-email" class="w-full p-3 mb-4 bg-gray-50 border rounded-lg" placeholder="البريد الإلكتروني" required>
                <input type="password" id="login-password" class="w-full p-3 mb-4 bg-gray-50 border rounded-lg" placeholder="كلمة المرور" required>
                <button id="login-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">دخول</button>
                <p class="text-center mt-4">ليس لديك حساب؟ <a href="#" id="show-signup" class="text-blue-600 hover:underline">أنشئ حساباً جديداً</a></p>
            </div>
            <!-- Signup Form -->
            <div id="signup-form" class="hidden">
                <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">إنشاء حساب جديد</h2>
                 <div id="signup-error" class="text-red-500 text-center mb-4 hidden"></div>
                <input type="email" id="signup-email" class="w-full p-3 mb-4 bg-gray-50 border rounded-lg" placeholder="البريد الإلكتروني" required>
                <input type="password" id="signup-password" class="w-full p-3 mb-4 bg-gray-50 border rounded-lg" placeholder="كلمة المرور (6 أحرف على الأقل)" required>
                <button id="signup-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors">إنشاء حساب</button>
                <p class="text-center mt-4">لديك حساب بالفعل؟ <a href="#" id="show-login" class="text-blue-600 hover:underline">سجل الدخول</a></p>
            </div>
        </div>
    </div>

    <!-- App Content -->
    <div id="app-content" class="container mx-auto p-4 sm:p-6 lg:p-8 hidden">
        <header class="text-center mb-8">
            <div class="flex justify-between items-center">
                <button id="logout-btn" class="text-sm bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600">تسجيل الخروج</button>
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">نظام حساب الأرباح</h1>
                <div class="w-20"></div> <!-- Spacer -->
            </div>
            <p id="user-email" class="text-gray-600 mt-2"></p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <!-- Basic Product Info -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-gray-700">البيانات الأساسية للمنتج</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="costPrice" class="block text-sm font-medium text-gray-600 mb-1">سعر التكلفة للقطعة ($)</label>
                            <input type="number" id="costPrice" class="w-full p-3 bg-gray-50 border rounded-lg" placeholder="0">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                             <div>
                                <label for="sellPrice" class="block text-sm font-medium text-gray-600 mb-1">سعر البيع ($)</label>
                                <input type="number" id="sellPrice" class="w-full p-3 bg-gray-50 border rounded-lg" placeholder="0">
                             </div>
                             <div class="relative">
                                <label for="discountPercentage" class="block text-sm font-medium text-gray-600 mb-1">خصم</label>
                                <input type="number" id="discountPercentage" class="w-full p-3 bg-gray-50 border rounded-lg pr-8" placeholder="0">
                                <span class="absolute left-2 top-1/2 mt-3 -translate-y-1/2 text-gray-500">%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Stock Management -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-gray-700">إدارة المخزون</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">المخزون المتوفر حالياً</label>
                            <div id="availableStockDisplay" class="w-full p-3 bg-gray-200 border rounded-lg font-bold text-lg">0</div>
                        </div>
                        <div class="flex items-end gap-2">
                            <div class="flex-grow">
                                <label for="stockAdjustment" class="block text-sm font-medium text-gray-600 mb-1">تعديل الكمية</label>
                                <input type="number" id="stockAdjustment" class="w-full p-3 bg-gray-50 border rounded-lg" placeholder="0">
                            </div>
                            <button id="addStockBtn" class="bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600" title="إضافة للمخزون">+</button>
                            <button id="removeStockBtn" class="bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600" title="إزالة من المخزون">-</button>
                        </div>
                    </div>
                     <div id="low-stock-warning" class="hidden mt-4 p-3 bg-yellow-100 text-yellow-800 border-r-4 border-yellow-500 rounded-lg"></div>
                </div>
                <!-- Record a Sale -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-gray-700">تسجيل عملية بيع جديدة</h2>
                    <div class="flex items-end gap-4">
                        <div class="flex-grow"><input type="number" id="newSaleQty" class="w-full p-3 bg-gray-50 border rounded-lg" placeholder="عدد القطع المباعة"></div>
                        <button id="recordSaleBtn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700">تسجيل البيع</button>
                    </div>
                </div>
                <!-- Expenses -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-gray-700">المصاريف التشغيلية ($)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="number" id="marketingExpenses" class="w-full p-3 bg-gray-50 border rounded-lg" placeholder="مصاريف التسويق">
                        <input type="number" id="toolsExpenses" class="w-full p-3 bg-gray-50 border rounded-lg" placeholder="مصاريف الأدوات">
                        <input type="number" id="otherExpenses" class="w-full p-3 bg-gray-50 border rounded-lg" placeholder="مصاريف أخرى">
                    </div>
                </div>
            </div>
            <!-- Results Column -->
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-gray-700">ملخص الأرباح</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg"><span class="font-medium">الربح من كل قطعة</span><h3 id="profitPerItem" class="text-xl font-bold">$0.00</h3></div>
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg"><span class="font-medium">إجمالي القطع المباعة</span><h3 id="totalSoldStock" class="text-xl font-bold">0</h3></div>
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg"><span class="font-medium">إجمالي الربح الأولي</span><h3 id="totalInitialProfit" class="text-xl font-bold">$0.00</h3></div>
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg"><span class="font-medium">إجمالي المصاريف</span><h3 id="totalExpenses" class="text-xl font-bold text-red-500">$0.00</h3></div>
                    </div>
                </div>
                <div class="bg-blue-600 text-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-2">صافي الربح النهائي</h2>
                    <div class="text-center"><h3 id="netProfit" class="text-5xl font-extrabold my-4">$0.00</h3></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                     <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-gray-700">سجل المبيعات</h2>
                     <div id="salesHistoryList" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const loader = document.getElementById('loader');
        const authContainer = document.getElementById('auth-container');
        const appContent = document.getElementById('app-content');
        // Auth forms
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        // App elements
        const userEmailEl = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const allInputs = ['costPrice', 'sellPrice', 'discountPercentage', 'marketingExpenses', 'toolsExpenses', 'otherExpenses', 'newSaleQty'];
        const elements = {};
        allInputs.forEach(id => elements[id] = document.getElementById(id));
        const availableStockDisplayEl = document.getElementById('availableStockDisplay');
        const lowStockWarningEl = document.getElementById('low-stock-warning');
        const profitPerItemEl = document.getElementById('profitPerItem');
        const totalSoldStockEl = document.getElementById('totalSoldStock');
        const totalInitialProfitEl = document.getElementById('totalInitialProfit');
        const totalExpensesEl = document.getElementById('totalExpenses');
        const netProfitEl = document.getElementById('netProfit');
        const salesHistoryListEl = document.getElementById('salesHistoryList');
        const toastEl = document.getElementById('toast');
        
        // --- State ---
        let db, auth, dataRef, localData = {}, unsubscribe;

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            // =================================================================
            // TODO: استبدل هذا الكائن بإعدادات Firebase الخاصة بك
            // اتبع الدليل للحصول على هذه الإعدادات من حسابك في Firebase
           const firebaseConfig = {
              apiKey: "AIzaSyCJIoPt0J0UocGGVdiQSnxicHv9UL0G49g",
              authDomain: "my-profit-app-28526.firebaseapp.com",
              projectId: "my-profit-app-28526",
              storageBucket: "my-profit-app-28526.appspot.com",
              messagingSenderId: "89143914718",
              appId: "1:89143914718:web:2aa11dee0399c15bdd524f"
            };
            // =================================================================

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                handleAuthState();
            } catch (error) {
                console.error("Firebase Init Error:", error);
                if(firebaseConfig.apiKey === "YOUR_API_KEY") {
                    showToast("الرجاء إضافة إعدادات Firebase الخاصة بك في الكود أولاً.", true);
                } else {
                    showToast("خطأ فادح في تهيئة التطبيق.", true);
                }
                loader.classList.add('hidden');
                authContainer.classList.remove('hidden');
            }
        }

        function handleAuthState() {
            onAuthStateChanged(auth, user => {
                if (unsubscribe) unsubscribe(); 
                if (user) {
                    authContainer.classList.add('hidden');
                    appContent.classList.remove('hidden');
                    userEmailEl.textContent = `مرحباً بك، ${user.email}`;
                    setupFirestoreListener(user.uid);
                } else {
                    authContainer.classList.remove('hidden');
                    appContent.classList.add('hidden');
                    loader.classList.add('hidden');
                }
            });
        }

        function setupFirestoreListener(userId) {
            loader.classList.remove('hidden');
            dataRef = doc(db, `users/${userId}/data/main`);
            
            unsubscribe = onSnapshot(dataRef, (docSnap) => {
                if (docSnap.exists()) {
                    localData = docSnap.data();
                } else {
                    console.log("No data, creating new document.");
                    localData = getInitialData();
                    setDoc(dataRef, localData);
                }
                updateUI();
                loader.classList.add('hidden');
            }, (error) => {
                console.error("Firestore listener error:", error);
                showToast("خطأ في الاتصال بقاعدة البيانات.", true);
                loader.classList.add('hidden');
            });
        }
        
        function getInitialData() {
            return {
                costPrice: 0, sellPrice: 0, availableStock: 0, discountPercentage: 0,
                marketingExpenses: 0, toolsExpenses: 0, otherExpenses: 0,
                salesHistory: []
            };
        }

        function updateUI() {
            if (!localData) return;
            // Update input fields
            elements.costPrice.value = localData.costPrice || 0;
            elements.sellPrice.value = localData.sellPrice || 0;
            elements.discountPercentage.value = localData.discountPercentage || 0;
            availableStockDisplayEl.textContent = localData.availableStock || 0;
            elements.marketingExpenses.value = localData.marketingExpenses || 0;
            elements.toolsExpenses.value = localData.toolsExpenses || 0;
            elements.otherExpenses.value = localData.otherExpenses || 0;

            // Low stock warning
            if (localData.availableStock > 0 && localData.availableStock <= 3) {
                lowStockWarningEl.textContent = `تنبيه: تبقى ${localData.availableStock} قطعة فقط في المخزون!`;
                lowStockWarningEl.classList.remove('hidden');
            } else {
                lowStockWarningEl.classList.add('hidden');
            }

            // Calculations
            const { costPrice, sellPrice, salesHistory, marketingExpenses, toolsExpenses, otherExpenses, discountPercentage } = localData;
            const totalSoldStock = salesHistory ? salesHistory.reduce((sum, sale) => sum + sale.quantity, 0) : 0;
            const finalSellPrice = (sellPrice || 0) * (1 - (discountPercentage || 0) / 100);
            const profitPerItem = finalSellPrice - (costPrice || 0);
            const totalInitialProfit = profitPerItem * totalSoldStock;
            const totalExpenses = (marketingExpenses || 0) + (toolsExpenses || 0) + (otherExpenses || 0);
            const netProfit = totalInitialProfit - totalExpenses;
            
            // Update displays
            const formatCurrency = (value) => `$${(value || 0).toFixed(2)}`;
            profitPerItemEl.textContent = formatCurrency(profitPerItem);
            totalSoldStockEl.textContent = totalSoldStock;
            totalInitialProfitEl.textContent = formatCurrency(totalInitialProfit);
            totalExpensesEl.textContent = formatCurrency(totalExpenses);
            netProfitEl.textContent = formatCurrency(netProfit);
            
            // Dynamic coloring
            profitPerItemEl.classList.toggle('positive', profitPerItem > 0);
            profitPerItemEl.classList.toggle('negative', profitPerItem < 0);
            const netProfitCard = netProfitEl.parentElement.parentElement;
            netProfitCard.classList.remove('bg-blue-600', 'bg-green-600', 'bg-red-600');
            if (netProfit > 0) netProfitCard.classList.add('bg-green-600');
            else if (netProfit < 0) netProfitCard.classList.add('bg-red-600');
            else netProfitCard.classList.add('bg-blue-600');
            
            // Update Sales History
            salesHistoryListEl.innerHTML = '';
            if (salesHistory && salesHistory.length > 0) {
                salesHistory.slice().reverse().forEach(sale => {
                    // FIX: Check if sale and sale.date exist to prevent crash on malformed data.
                    if (sale && sale.date) {
                        const saleEl = document.createElement('div');
                        saleEl.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-md';
                        const saleDate = sale.date.toDate ? sale.date.toDate() : new Date(sale.date);
                        saleEl.innerHTML = `<span class="text-sm text-gray-700">بيع ${sale.quantity} قطعة</span><span class="text-xs text-gray-500">${saleDate.toLocaleString('ar-SA')}</span>`;
                        salesHistoryListEl.appendChild(saleEl);
                    }
                });
            } else {
                salesHistoryListEl.innerHTML = '<p class="text-gray-500">لا توجد عمليات بيع مسجلة بعد.</p>';
            }
        }

        // --- Auth Event Handlers ---
        showSignup.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); });
        showLogin.addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });

        document.getElementById('signup-btn').addEventListener('click', () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const errorEl = document.getElementById('signup-error');
            errorEl.classList.add('hidden');
            createUserWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    errorEl.textContent = "خطأ: " + error.message;
                    errorEl.classList.remove('hidden');
                });
        });

        document.getElementById('login-btn').addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.classList.add('hidden');
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    errorEl.textContent = "خطأ: البريد الإلكتروني أو كلمة المرور غير صحيحة.";
                    errorEl.classList.remove('hidden');
                });
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- App Event Handlers ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), 700); };
        }
        async function updateField(fieldName, value) {
            if (dataRef) {
                try { await updateDoc(dataRef, { [fieldName]: value }); }
                catch (error) { console.error("Update Error:", error); showToast("خطأ في حفظ البيانات.", true); }
            }
        }
        const debouncedUpdate = debounce(updateField, 700);
        ['costPrice', 'sellPrice', 'discountPercentage', 'marketingExpenses', 'toolsExpenses', 'otherExpenses'].forEach(id => {
            elements[id].addEventListener('input', () => debouncedUpdate(id, parseFloat(elements[id].value) || 0));
        });

        async function adjustStock(isAdding) {
            const stockAdjustmentEl = document.getElementById('stockAdjustment');
            const adjustmentValue = parseInt(stockAdjustmentEl.value);
            if (!adjustmentValue || adjustmentValue <= 0) {
                showToast("الرجاء إدخال كمية صحيحة للتعديل.", true);
                return;
            }

            const currentStock = localData.availableStock || 0;
            let newStock;

            if (isAdding) {
                newStock = currentStock + adjustmentValue;
            } else {
                if (adjustmentValue > currentStock) {
                    showToast("لا يمكن إزالة كمية أكبر من المخزون الحالي.", true);
                    return;
                }
                newStock = currentStock - adjustmentValue;
            }
            
            await updateField('availableStock', newStock);
            stockAdjustmentEl.value = '';
            showToast("تم تحديث المخزون بنجاح!");
        }

        document.getElementById('addStockBtn').addEventListener('click', () => adjustStock(true));
        document.getElementById('removeStockBtn').addEventListener('click', () => adjustStock(false));

        document.getElementById('recordSaleBtn').addEventListener('click', async () => {
            const quantity = parseInt(elements.newSaleQty.value);
            if (!quantity || quantity <= 0) { showToast("الرجاء إدخال كمية صحيحة.", true); return; }
            if (quantity > localData.availableStock) { showToast("الكمية المباعة أكبر من المخزون المتوفر!", true); return; }
            const newSale = { quantity: quantity, date: new Date() };
            const newStock = localData.availableStock - quantity;
            try {
                await updateDoc(dataRef, { availableStock: newStock, salesHistory: arrayUnion(newSale) });
                elements.newSaleQty.value = '';
                showToast("تم تسجيل البيع بنجاح!");
            } catch (error) {
                console.error("Sale Error:", error);
                showToast("حدث خطأ أثناء تسجيل البيع.", true);
            }
        });
        
        function showToast(message, isError = false) {
            toastEl.textContent = message;
            toastEl.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), 3000);
        }

        // --- Start the application ---
        initializeFirebase();
    </script>
</body>
</html>
